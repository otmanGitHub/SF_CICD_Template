name: Validate PR on develop branch
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€

# Definition when the workflow should run
on:
    pull_request:
        # The events are that a PR is opened, or when a commit is pushed
        types: [opened, synchronize]
        # The branches filter allows to specify that this workflow should only
        # branches: [ feature/** ]
        # Trigger the pipeline only when changes are made in specific paths
        paths:
        # - 'force-app/**'

jobs:
  validate-pmd:
        # Add write permission to security-events to be able to upload sarif file
        permissions:
          contents: read
          security-events: write
          actions: read

        runs-on: ubuntu-24.04
        if: ${{ github.actor != 'dependabot[bot]' }}
        steps:
        # ___________________________________________START PACKAGES INSTALLATION_________________________________________________
        - name: installing node version
          uses: actions/setup-node@v5
          with:
            node-version: '22'

        - name: 'Checkout source code'
          uses: actions/checkout@v5
          with:
            fetch-depth: 0

        - name: 'Install Salesforce CLI'
          run: |
            npm install -g @salesforce/cli@2.108.6
            sf version

        # Java is required to run the SFDX code analyzer
        # default-jdk is the version corresponding to the Ubuntu version (e.g. Ubuntu 24.04 -> OpenJDK 21)
        - name: 'Installing java'
          run: |
            sudo apt-get update
            sudo apt install default-jdk

        # Install required plugins
        - name: 'Installing SFDX scanner'
          run: |
            echo y | sf plugins install @salesforce/plugin-code-analyzer@5.5.0
            echo y | sf plugins install sfdx-git-delta@6.22.0
            echo y | sf plugins install lightning-flow-scanner@5.7.2
            sf plugins

        # ___________________________________________START JOBS EXECUTIONS_________________________________________________

        # TWe load SFDX_INTEGRATION_URL store in the repository secrets variable, the url can be genereated using sf org display --verbose
        # After being loaded, it is stored in a text file that will be used to authenticate to the integration org
        - name: 'Populate auth file with SFDX_URL secret of integration org'
          run: |
              echo ${{ secrets.SFDX_INTEGRATION_URL}} > ./SFDX_INTEGRATION_URL.txt
          
        # Authenticate to org using the URL stored in the text file
        - name: 'Authenticate to Integration Org'
          run: sf org login sfdx-url --sfdx-url-file ./SFDX_INTEGRATION_URL.txt --set-default --alias integration

        # This command generates a delta between the SHA of the head of the PR feature and the SHA of the HEAD of the target branch of the PR
        # 
        - name: 'Create delta packages for new, modified or deleted metadata'
          run: | 
            mkdir changed-sources
            sf sgd source delta --to "HEAD" --from "${{github.event.pull_request.base.sha}}" --output-dir changed-sources/ --generate-delta --source-dir force-app/
            echo 'delta package generated ! between PR HEAD SHA1 :${{github.event.pull_request.head.sha}} and PR Target Branch SHA1 :${{github.event.pull_request.base.sha}}'
          
        # This step add in the changed-sources/force-app/main/default/classes/ all the apex classes that have the "Test" suffix of a modified apex test
        - name: 'Add modified apex test classes to deployment package'
          run: |
            for file in changed-sources/force-app/main/default/classes/*.cls; do
              base_name=$(basename "$file" .cls)
              if [[ ! "$base_name" =~ Test$ ]]; then
                test_class="force-app/main/default/classes/${base_name}Test.cls"
                test_meta="force-app/main/default/classes/${base_name}Test.cls-meta.xml"
                dest_class="changed-sources/force-app/main/default/classes/${base_name}Test.cls"
                dest_meta="changed-sources/force-app/main/default/classes/${base_name}Test.cls-meta.xml"
                if [ -f "$test_class" ] && [ ! -f "$dest_class" ]; then
                  cp "$test_class" changed-sources/force-app/main/default/classes/
                  if [ -f "$test_meta" ] && [ ! -f "$dest_meta" ]; then
                    cp "$test_meta" changed-sources/force-app/main/default/classes/
                  fi
                fi
              fi
            done

        # The .sarif file can later be uploaded to github, so that we can see the results of the scan directly from the PR.
        - name: '@Salesforce/plugin-code-analyzer run all default rule'
          run: |
              sf code-analyzer run --rule-selector pmd --rule-selector eslint --target 'changed-sources/**/*' --output-file 'pmdScanResults.sarif.json'
              
        # It is not possible to upload a sarif file in a private repository, is is only possible to upldate .csv or .json files.
        - name: Upload SARIF file
          uses: github/codeql-action/upload-sarif@v3
          with:
            sarif_file: pmdScanResults.sarif.json

        # generate flow scan report in text format
        - name: 'Run Flow Scanner on changed flows'
          run: |
              sf flow:scan --directory changed-sources/force-app/main/default/flows > lightning-flow-scan_result.txt

        # import the flow scan report as a PR comment
        - name: 'Comment flow scan result on PR'

        # We do a check-only deploy and we only run the tests specified in the PR 
        # Now we validate every rules of the PMD and EsLint engines
        - name: 'Check conf and tests on changed sources folder'
          run: |
              sf project deploy start --source-dir changed-sources/force-app --dry-run --test-level RunLocalTests

        # /! Not implemented yet !\
        # - name: 'Deploy destructive changes (if any)' => Not implemented yet
        #   run: sfdx force:mdapi:deploy -d "changed-sources/destructiveChanges" --checkonly --ignorewarnings 

#_________________________________________HELP DEBUG COMMANDS _________________________________________________

# Display generated apex code file for debug
# - name: 'Display AccountController.cls file content and js file content'
#   run: |
#       cat changed-sources/force-app/main/default/classes/AccountController.cls
#       cat changed-sources/force-app/main/default/classes/AccountControllerTest.cls


# Display the content of the changed-sources directory recurcively for debug
# - name: 'Display changed-sources directory content'
#   run: |
#       echo "Changed sources directory content:"
#       ls -R changed-sources/


# display full directory tree for debug
# - name: 'Display complete directory tree'
#   run: |
#     sudo apt-get install -y tree
#     tree -L 10 /home/runner/work/

# display sarif file content for debug
# - name: 'Display SARIF file content'
#   run: |
#       cat pmdScanResults.sarif.json